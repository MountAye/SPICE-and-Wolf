(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{394:function(t,a,s){t.exports=s.p+"assets/img/Netfilter-packet-flow.250c9d2b.svg"},435:function(t,a,s){"use strict";s.r(a);var e=s(43),r=Object(e.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"防火墙工具-iptables"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#防火墙工具-iptables"}},[t._v("#")]),t._v(" 防火墙工具 iptables")]),t._v(" "),e("h1",{attrs:{id:"iptables是个啥"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#iptables是个啥"}},[t._v("#")]),t._v(" iptables是个啥")]),t._v(" "),e("p",[t._v("iptables是一个运行在用户空间的应用软件，通过控制Linux内核netfilter模块，来管理网络数据包的流动与转送。iptables的操作需要用到超级用户的权限。")]),t._v(" "),e("p",[t._v("简而言之，iptables是Linux上自带的防火墙，然而它的功能远远不止于此，通过控制 netfilter 模块来管理网络数据包的流动与转送，iptables哈可以做到端口转发。")]),t._v(" "),e("h1",{attrs:{id:"iptables的结构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#iptables的结构"}},[t._v("#")]),t._v(" iptables的结构")]),t._v(" "),e("h2",{attrs:{id:"表-tables"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#表-tables"}},[t._v("#")]),t._v(" 表 tables")]),t._v(" "),e("p",[t._v("“表”和不同的数据包处理有关。")]),t._v(" "),e("p",[t._v("我们常说，iptables是“四表五链”(或者三表五链)，实际上iptables一共有五个表：")]),t._v(" "),e("ul",[e("li",[t._v("raw 用于配置数据包，raw 中的数据包不会被系统跟踪。")]),t._v(" "),e("li",[t._v("filter 是用于存放所有与防火墙相关操作的默认表。")]),t._v(" "),e("li",[t._v("nat 用于 网络地址转换（例如：端口转发）。")]),t._v(" "),e("li",[t._v("mangle 用于对特定数据包的修改（参考 损坏数据包）。")]),t._v(" "),e("li",[t._v("security 用于 强制访问控制 网络规则\n我们平时一般主要会用到 "),e("strong",[t._v("filter")]),t._v(" 和 "),e("strong",[t._v("nat")]),t._v("，其中 filter 链会拿来做咱们传统意义上的“防火墙”，nat链一般就拿来做转发了。")])]),t._v(" "),e("h2",{attrs:{id:"链-chains"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#链-chains"}},[t._v("#")]),t._v(" 链 chains")]),t._v(" "),e("p",[t._v('决定数据包是否可以穿越的是 "链"。')]),t._v(" "),e("p",[t._v("iptables中共有五个链：")]),t._v(" "),e("ul",[e("li",[t._v("PREROUTING")]),t._v(" "),e("li",[t._v("INPUT")]),t._v(" "),e("li",[t._v("FORWARD")]),t._v(" "),e("li",[t._v("OUTPUT")]),t._v(" "),e("li",[t._v("POSTROUTING")])]),t._v(" "),e("p",[t._v("默认来说， filter 表包含 INPUT， OUTPUT 和 FORWARD 3条内建的链，这3条链作用于数据包过滤过程中的不同时间点。实在是太好理解了，INPUT, FORWARD, OUTPUT 就是对包的入、转发、出进行定义的三个过滤链，我们通过操作这三个链可以实现防火墙功能；nat 表包含PREROUTING， POSTROUTING 和 OUTPUT 链。\n需要注意的是，每个表之间存在优先级，mangle > nat > filter")]),t._v(" "),e("h2",{attrs:{id:"规则-rules"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#规则-rules"}},[t._v("#")]),t._v(" 规则 rules")]),t._v(" "),e("p",[t._v('一条 "规则" 在链里面则可以决定是否送往下一条链（或其它的动作），比如说ACCEPT， DROP，我猜大家都懂的。')]),t._v(" "),e("h1",{attrs:{id:"前世今生"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前世今生"}},[t._v("#")]),t._v(" 前世今生")]),t._v(" "),e("p",[e("img",{attrs:{src:s(394),alt:""}}),t._v("\n图片来自维基百科，Arch Linux 上有一个"),e("a",{attrs:{href:"https://www.frozentux.net/iptables-tutorial/images/tables_traverse.jpg",target:"_blank",rel:"noopener noreferrer"}},[t._v("更简洁的图"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("我们大致可以看出：包首先要由 bridge check 来判断属于链路层还是网络层，之后包都会遇到 NAT 或者 mangle 表的 PREROUTING 链，从这 pre 前缀咱能才出来，这是要在路由之前要过的链。")]),t._v(" "),e("p",[t._v("接着当包通过了 PREROUTING 之后，便到了 decision 这个分支点，这里有一个对目的地址的判断，如果包的目的地是本地, 那么包向上走，走入 INPUT 链处理，然后进入 LOCAL PROCESS，之后再进入对应的 OUTPUT、POSTROUTING；")]),t._v(" "),e("p",[t._v("如果非本地，那么就进入 FORWARD 链进行转发，之后再走 POSTROUTING，我们在这里就不说 FORWARD 链的事了。")]),t._v(" "),e("p",[t._v("我们可以看到，filter 表在包的处理流程中，处于中间的位置，这部分也就是防火墙的主要功能所在。")]),t._v(" "),e("h1",{attrs:{id:"iptables-的基本用法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#iptables-的基本用法"}},[t._v("#")]),t._v(" iptables 的基本用法")]),t._v(" "),e("p",[e("strong",[t._v("警告：错误的使用 iptables 可能会造成很悲剧的结果哦")])]),t._v(" "),e("p",[t._v("由于 iptables 用法比较复杂，咱下面就列几个比较常见的用法")]),t._v(" "),e("h2",{attrs:{id:"阻断某端口入网"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#阻断某端口入网"}},[t._v("#")]),t._v(" 阻断某端口入网")]),t._v(" "),e("h2",{attrs:{id:"允许-tcp-80-入网"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#允许-tcp-80-入网"}},[t._v("#")]),t._v(" 允许 TCP 80 入网")]),t._v(" "),e("p",[e("code",[t._v("iptables –A INPUT –p tcp –dport 80 –j ACCEPT")])]),t._v(" "),e("h2",{attrs:{id:"允许-ping"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#允许-ping"}},[t._v("#")]),t._v(" 允许 ping")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("iptables -A OUTPUT -p icmp -j ACCEPT\niptables -A INPUT -p icmp -j ACCEPT  \n")])])]),e("h2",{attrs:{id:"拒绝22入网"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#拒绝22入网"}},[t._v("#")]),t._v(" 拒绝22入网")]),t._v(" "),e("p",[e("code",[t._v("iptables -A INPUT -p tcp --dport 22 -j ACCEPT")])]),t._v(" "),e("h2",{attrs:{id:"开放-iptables"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#开放-iptables"}},[t._v("#")]),t._v(" 开放 iptables")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 首先，我们先把 INPUT、FORWARD、OUTPUT 这三个链的规则设置成 ACCEPT 免得把自己锁在门外：")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" iptables -P INPUT ACCEPT\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" iptables -P FORWARD ACCEPT\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" iptables -P OUTPUT ACCEPT\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 然后，我们清除 NAT、Mangle 表，清除链，删除所有的非默认链")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" iptables -t nat -F        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#清除NAT表")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" iptables -t mangle -F    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#清除mangle表")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" iptables -F    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#清除所有链的规则")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" iptables -X    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#删除非默认链")]),t._v("\n")])])]),e("p",[t._v("参考资料：\nhttps://xstarcd.github.io/wiki/Linux/iptables_forward_internetshare.html")])])}),[],!1,null,null,null);a.default=r.exports}}]);