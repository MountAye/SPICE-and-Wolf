(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{455:function(t,s,e){"use strict";e.r(s);var r=e(43),v=Object(r.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"btrfs"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#btrfs"}},[t._v("#")]),t._v(" Btrfs")]),t._v(" "),e("h2",{attrs:{id:"介绍"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#介绍"}},[t._v("#")]),t._v(" 介绍")]),t._v(" "),e("blockquote",[e("p",[t._v("Btrfs (Butter FS, "),e("em",[t._v("Better FS")]),t._v(", B-tree FS) 是一款支持 "),e("em",[t._v("CoW")]),t._v(" 特性的 Linux 现代文件系统，使用 "),e("strong",[t._v("GPL")]),t._v(" 开源协议授权，实现了包括_可写快照_、"),e("em",[t._v("RAID")]),t._v("、"),e("em",[t._v("子卷 (subvolumes)")]),t._v(" 等高级特性，同时，Btrfs 专注于"),e("strong",[t._v("高容错")]),t._v("、"),e("strong",[t._v("易修复")]),t._v("和"),e("strong",[t._v("易于管理")]),t._v("。自 2.6.29，Btrfs 已并入 Linux 内核主线，GRUB2 & Syslinux 也已支持 Btrfs。")])]),t._v(" "),e("h2",{attrs:{id:"准备"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#准备"}},[t._v("#")]),t._v(" 准备")]),t._v(" "),e("p",[t._v("Linux 内核支持 Btrfs 文件系统，但如果要使用 Btrfs 用户空间工具，你需要安装一些软件包。")]),t._v(" "),e("p",[t._v("Debian 6 ("),e("em",[t._v("squeeze")]),t._v(") ~ Debian 8 ("),e("em",[t._v("jessie")]),t._v(")")]),t._v(" "),e("p",[e("code",[t._v("apt install btrfs-tools")])]),t._v(" "),e("p",[t._v("Debian 9 ("),e("em",[t._v("stretch")]),t._v(") ~")]),t._v(" "),e("p",[e("code",[t._v("apt install btrfs-progs")])]),t._v(" "),e("h2",{attrs:{id:"分区和配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#分区和配置"}},[t._v("#")]),t._v(" 分区和配置")]),t._v(" "),e("h3",{attrs:{id:"常规"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#常规"}},[t._v("#")]),t._v(" 常规")]),t._v(" "),e("p",[t._v("在分区 /dev/partition 上创建 Btrfs 文件系统")]),t._v(" "),e("p",[e("code",[t._v("mkfs.btrfs -L label_name /dev/partition")])]),t._v(" "),e("p",[t._v("在单文件或目录上禁用 CoW")]),t._v(" "),e("p",[e("code",[t._v("chattr +C /dir/file")])]),t._v(" "),e("blockquote",[e("p",[e("em",[t._v("注：仅对新创建的文件有效，若要对已存在文件禁用 CoW，请新建另一空目录设置+C，并将原文件复制到该目录")])])]),t._v(" "),e("p",[t._v("轻量拷贝文件 ("),e("em",[t._v("Lightweight copy")]),t._v(")")]),t._v(" "),e("blockquote",[e("p",[e("em",[t._v("注：创建轻量(Lightweight)拷贝引用（指向）原数据")])])]),t._v(" "),e("p",[e("code",[t._v("cp --reflink source dest")])]),t._v(" "),e("p",[t._v("对已存在的文件/目录进行压缩")]),t._v(" "),e("p",[e("code",[t._v("btrfs filesystem defragment -r -v -calg /")])]),t._v(" "),e("p",[t._v("alg 可以是 zlib, lzo, zstd 或 no (不压缩)")]),t._v(" "),e("blockquote",[e("p",[e("em",[t._v("注：GRUB & rEFInd 暂时缺少 zstd 支持，请不要对其所在的 boot 分区进行 zstd 压缩")])])]),t._v(" "),e("p",[t._v("查看 Btrfs 磁盘使用率")]),t._v(" "),e("p",[e("code",[t._v("btrfs filesystem usage /")])]),t._v(" "),e("blockquote",[e("p",[e("em",[t._v("该方法比通用 df 命令结果更准确")])])]),t._v(" "),e("p",[t._v("Btrfs 手动磁盘整理")]),t._v(" "),e("p",[e("code",[t._v("btrfs filesystem defragment -r /")])]),t._v(" "),e("h3",{attrs:{id:"子卷"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#子卷"}},[t._v("#")]),t._v(" 子卷")]),t._v(" "),e("p",[t._v("创建新的 Btrfs 子卷")]),t._v(" "),e("p",[e("code",[t._v("btrfs subvolume create /path/to/subvolume")])]),t._v(" "),e("p",[t._v("查看目录下所有子卷")]),t._v(" "),e("p",[e("code",[t._v("btrfs subvolume list -p /path/with/subvolumes")])]),t._v(" "),e("p",[t._v("删除一个子卷")]),t._v(" "),e("p",[e("code",[t._v("btrfs subvolume delete /path/to/a/subvolume")])]),t._v(" "),e("p",[t._v("设置默认子卷为 subvol-id")]),t._v(" "),e("p",[e("code",[t._v("btrfs subvolume set-default subvol-id /")])]),t._v(" "),e("blockquote",[e("p",[e("em",[t._v("btrfs subvolume list 命令可列出子卷 ID")])])]),t._v(" "),e("h3",{attrs:{id:"磁盘配额"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#磁盘配额"}},[t._v("#")]),t._v(" 磁盘配额")]),t._v(" "),e("blockquote",[e("p",[t._v("Under Construction ...")])]),t._v(" "),e("h3",{attrs:{id:"raid"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#raid"}},[t._v("#")]),t._v(" RAID")]),t._v(" "),e("blockquote",[e("p",[t._v("Under Construction ...")])]),t._v(" "),e("h3",{attrs:{id:"ssd-trim"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ssd-trim"}},[t._v("#")]),t._v(" SSD Trim")]),t._v(" "),e("p",[t._v("Btrfs 支持 discard 和 fstrim 以释放未被使用的块")]),t._v(" "),e("h3",{attrs:{id:"scrub"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#scrub"}},[t._v("#")]),t._v(" Scrub")]),t._v(" "),e("p",[t._v("这是一个 Btrfs 文件系统检查工具")]),t._v(" "),e("p",[t._v("后台开始检查目录任务")]),t._v(" "),e("p",[e("code",[t._v("btrfs scrub start /")])]),t._v(" "),e("p",[t._v("查看目录检查状态")]),t._v(" "),e("p",[e("code",[t._v("btrfs scrub status /")])]),t._v(" "),e("h3",{attrs:{id:"快照-snapshot"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#快照-snapshot"}},[t._v("#")]),t._v(" 快照 Snapshot")]),t._v(" "),e("p",[t._v("新建一个快照/只读快照")]),t._v(" "),e("p",[e("code",[t._v("btrfs subvolume snapshot source [dest/]name")])]),t._v(" "),e("p",[e("code",[t._v("btrfs subvolume snapshot -r source [dest/]name")])]),t._v(" "),e("h2",{attrs:{id:"文件恢复"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#文件恢复"}},[t._v("#")]),t._v(" 文件恢复")]),t._v(" "),e("p",[e("strong",[t._v("btrfs restore")]),t._v(" 命令支持离线 Btrfs 磁盘的文件恢复操作。在尝试文件恢复前，请尽量不再往目标磁盘写入数据，避免要恢复的文件被覆盖消失。")]),t._v(" "),e("p",[t._v("启动 LiveCD 环境并确保未挂载目标磁盘，安装 btrfs 用户空间工具 btrfs-tools/progs，使用下面的命令进行文件恢复操作。")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 假设目标磁盘为 /dev/sdb")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 恢复所有文件到 /mnt/restore")]),t._v("\nbtrfs restore /dev/sdb /mnt/restore\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 恢复所有文件并恢复软连接和文件 meta")]),t._v("\nbtrfs restore -m -S /dev/sdb /mnt/restore\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 恢复单个文件")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## 首先 -D 参数 dry run 查看是否能找到需要的文件")]),t._v("\nbtrfs restore -D --path-regex "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'[文件路径的正则表示]'")]),t._v(" /dev/sdb /mnt/restore\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## 如果找到文件则继续恢复文件")]),t._v("\nbtrfs restore -m -S --path-regex "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'[文件路径的正则表示]'")]),t._v(" /dev/sdb /mnt/restore\n")])])]),e("h2",{attrs:{id:"从-ext3-4-迁移到-btrfs"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#从-ext3-4-迁移到-btrfs"}},[t._v("#")]),t._v(" 从 Ext3/4 迁移到 Btrfs")]),t._v(" "),e("p",[t._v("从 CD Live 环境引导以离线转换磁盘，此部分请阅读本魔法书其他部分，转换前请"),e("strong",[t._v("务必")]),t._v("备份您的重要数据")]),t._v(" "),e("p",[t._v("对 /dev/partition 分区进行 Btrfs 转换")]),t._v(" "),e("p",[e("code",[t._v("btrfs-convert /dev/partition")])]),t._v(" "),e("blockquote",[e("p",[e("em",[t._v("转换后确保修改 /etc/fstab 中的挂载类型和磁盘 UUID，您可以 chroot 进您的 Debian 系统重建您的 GRUB 引导，如果您转换的是根分区，还需要重建 initramfs")])])]),t._v(" "),e("p",[t._v("确认无误且系统正常引导后可删除文件系统转换备份子卷")]),t._v(" "),e("p",[e("code",[t._v("btrfs subvolume delete /ext2_saved")])]),t._v(" "),e("p",[t._v("最后 blance 整个文件系统来回收可用空间")]),t._v(" "),e("p",[e("code",[t._v("btrfs blance start /")])]),t._v(" "),e("h2",{attrs:{id:"已知问题-known-issues"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#已知问题-known-issues"}},[t._v("#")]),t._v(" 已知问题 Known Issues")]),t._v(" "),e("blockquote",[e("p",[t._v("Under Construction ...")])]),t._v(" "),e("h2",{attrs:{id:"参考资料"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[t._v("#")]),t._v(" 参考资料")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://wiki.archlinux.org/index.php/Btrfs",target:"_blank",rel:"noopener noreferrer"}},[t._v("Btrfs - ArchWiki"),e("OutboundLink")],1),t._v(" "),e("a",{attrs:{href:"https://wiki.debian.org/Btrfs",target:"_blank",rel:"noopener noreferrer"}},[t._v("Btrfs - DebianWiki"),e("OutboundLink")],1),t._v(" "),e("a",{attrs:{href:"https://btrfs.wiki.kernel.org/index.php/Main_Page",target:"_blank",rel:"noopener noreferrer"}},[t._v("Btrfs Wiki"),e("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=v.exports}}]);