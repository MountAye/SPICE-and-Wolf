<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>防火墙工具 iptables | SPICE and Wolf （暂定）</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="Just playing around">
    <link rel="preload" href="/SPICE-and-Wolf/assets/css/0.styles.25ef1b29.css" as="style"><link rel="preload" href="/SPICE-and-Wolf/assets/js/app.d40a4ed0.js" as="script"><link rel="preload" href="/SPICE-and-Wolf/assets/js/2.a9de799e.js" as="script"><link rel="preload" href="/SPICE-and-Wolf/assets/js/11.15bdea7e.js" as="script"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/10.aef1d7cd.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/12.f159d74e.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/13.0f5c2711.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/14.e7ef6e4f.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/15.00737c9b.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/16.4092e87b.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/17.0b629da1.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/18.8242a61e.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/19.ed0381c0.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/20.68c1a7f5.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/21.6d304e33.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/22.e4500bfc.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/23.cff270dc.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/24.4cd5e626.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/25.5ac8d942.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/26.54713557.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/27.b1d1ebf0.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/28.09b50a0f.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/29.fc0bdbdd.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/3.bdeca7d2.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/30.09dccb0f.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/31.b451c8c0.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/32.2edd6be3.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/33.a2e2b89a.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/34.cd4b1ba6.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/35.38e98289.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/36.f70f6bcb.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/37.75f25dc4.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/38.cb5d2dcd.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/39.7e6b13f2.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/4.0446400c.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/40.62906212.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/41.76b847d9.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/42.a824c5e9.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/43.c46ec3b7.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/44.4765f48f.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/45.bb37421c.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/46.87b47a7f.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/5.fb2bf350.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/6.dea78bc5.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/7.4a7b06b2.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/8.fa25345f.js"><link rel="prefetch" href="/SPICE-and-Wolf/assets/js/9.38c152fb.js">
    <link rel="stylesheet" href="/SPICE-and-Wolf/assets/css/0.styles.25ef1b29.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/SPICE-and-Wolf/" class="home-link router-link-active"><!----> <span class="site-name">SPICE and Wolf （暂定）</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/SPICE-and-Wolf/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/SPICE-and-Wolf/drafts/.html#" class="nav-link">
  Placeholder
</a></div> <a href="https://github.com/project-wolves/SPICE-and-Wolf" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/SPICE-and-Wolf/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/SPICE-and-Wolf/drafts/.html#" class="nav-link">
  Placeholder
</a></div> <a href="https://github.com/project-wolves/SPICE-and-Wolf" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/SPICE-and-Wolf/" class="sidebar-heading clickable router-link-active open"><span>首页</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/SPICE-and-Wolf/plans.html" class="sidebar-link">规划中目录</a></li><li><a href="/SPICE-and-Wolf/drafts/" aria-current="page" class="sidebar-link">施工中页面</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>总次</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/SPICE-and-Wolf/knowledges_and_histories/" class="sidebar-link">科普和史话</a></li><li><a href="/SPICE-and-Wolf/experiences_from_writers/" class="sidebar-link">编者经验谈</a></li><li><a href="/SPICE-and-Wolf/install_arch_linux/" class="sidebar-link">安装 Arch Linux</a></li><li><a href="/SPICE-and-Wolf/softwares/" class="sidebar-link">使用各种软件</a></li><li><a href="/SPICE-and-Wolf/basic_usage/" class="sidebar-link">基本使用</a></li><li><a href="/SPICE-and-Wolf/troubleshooting/" class="sidebar-link">故障排除</a></li><li><a href="/SPICE-and-Wolf/virtualbox_install_and_usage/" class="sidebar-link">附录：安装和设置 VirtualBox</a></li><li><a href="/SPICE-and-Wolf/further_reading/" class="sidebar-link">前方的路</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="防火墙工具-iptables"><a href="#防火墙工具-iptables" class="header-anchor">#</a> 防火墙工具 iptables</h1> <h1 id="iptables是个啥"><a href="#iptables是个啥" class="header-anchor">#</a> iptables是个啥</h1> <p>iptables是一个运行在用户空间的应用软件，通过控制Linux内核netfilter模块，来管理网络数据包的流动与转送。iptables的操作需要用到超级用户的权限。</p> <p>简而言之，iptables是Linux上自带的防火墙，然而它的功能远远不止于此，通过控制 netfilter 模块来管理网络数据包的流动与转送，iptables哈可以做到端口转发。</p> <h1 id="iptables的结构"><a href="#iptables的结构" class="header-anchor">#</a> iptables的结构</h1> <h2 id="表-tables"><a href="#表-tables" class="header-anchor">#</a> 表 tables</h2> <p>“表”和不同的数据包处理有关。</p> <p>我们常说，iptables是“四表五链”(或者三表五链)，实际上iptables一共有五个表：</p> <ul><li>raw 用于配置数据包，raw 中的数据包不会被系统跟踪。</li> <li>filter 是用于存放所有与防火墙相关操作的默认表。</li> <li>nat 用于 网络地址转换（例如：端口转发）。</li> <li>mangle 用于对特定数据包的修改（参考 损坏数据包）。</li> <li>security 用于 强制访问控制 网络规则
我们平时一般主要会用到 <strong>filter</strong> 和 <strong>nat</strong>，其中 filter 链会拿来做咱们传统意义上的“防火墙”，nat链一般就拿来做转发了。</li></ul> <h2 id="链-chains"><a href="#链-chains" class="header-anchor">#</a> 链 chains</h2> <p>决定数据包是否可以穿越的是 &quot;链&quot;。</p> <p>iptables中共有五个链：</p> <ul><li>PREROUTING</li> <li>INPUT</li> <li>FORWARD</li> <li>OUTPUT</li> <li>POSTROUTING</li></ul> <p>默认来说， filter 表包含 INPUT， OUTPUT 和 FORWARD 3条内建的链，这3条链作用于数据包过滤过程中的不同时间点。实在是太好理解了，INPUT, FORWARD, OUTPUT 就是对包的入、转发、出进行定义的三个过滤链，我们通过操作这三个链可以实现防火墙功能；nat 表包含PREROUTING， POSTROUTING 和 OUTPUT 链。
需要注意的是，每个表之间存在优先级，mangle &gt; nat &gt; filter</p> <h2 id="规则-rules"><a href="#规则-rules" class="header-anchor">#</a> 规则 rules</h2> <p>一条 &quot;规则&quot; 在链里面则可以决定是否送往下一条链（或其它的动作），比如说ACCEPT， DROP，我猜大家都懂的。</p> <h1 id="前世今生"><a href="#前世今生" class="header-anchor">#</a> 前世今生</h1> <p><img src="/SPICE-and-Wolf/assets/img/Netfilter-packet-flow.250c9d2b.svg" alt="">
图片来自维基百科，Arch Linux 上有一个<a href="https://www.frozentux.net/iptables-tutorial/images/tables_traverse.jpg" target="_blank" rel="noopener noreferrer">更简洁的图<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>我们大致可以看出：包首先要由 bridge check 来判断属于链路层还是网络层，之后包都会遇到 NAT 或者 mangle 表的 PREROUTING 链，从这 pre 前缀咱能才出来，这是要在路由之前要过的链。</p> <p>接着当包通过了 PREROUTING 之后，便到了 decision 这个分支点，这里有一个对目的地址的判断，如果包的目的地是本地, 那么包向上走，走入 INPUT 链处理，然后进入 LOCAL PROCESS，之后再进入对应的 OUTPUT、POSTROUTING；</p> <p>如果非本地，那么就进入 FORWARD 链进行转发，之后再走 POSTROUTING，我们在这里就不说 FORWARD 链的事了。</p> <p>我们可以看到，filter 表在包的处理流程中，处于中间的位置，这部分也就是防火墙的主要功能所在。</p> <h1 id="iptables-的基本用法"><a href="#iptables-的基本用法" class="header-anchor">#</a> iptables 的基本用法</h1> <p><strong>警告：错误的使用 iptables 可能会造成很悲剧的结果哦</strong></p> <p>由于 iptables 用法比较复杂，咱下面就列几个比较常见的用法</p> <h2 id="阻断某端口入网"><a href="#阻断某端口入网" class="header-anchor">#</a> 阻断某端口入网</h2> <h2 id="允许-tcp-80-入网"><a href="#允许-tcp-80-入网" class="header-anchor">#</a> 允许 TCP 80 入网</h2> <p><code>iptables –A INPUT –p tcp –dport 80 –j ACCEPT</code></p> <h2 id="允许-ping"><a href="#允许-ping" class="header-anchor">#</a> 允许 ping</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>iptables -A OUTPUT -p icmp -j ACCEPT
iptables -A INPUT -p icmp -j ACCEPT  
</code></pre></div><h2 id="拒绝22入网"><a href="#拒绝22入网" class="header-anchor">#</a> 拒绝22入网</h2> <p><code>iptables -A INPUT -p tcp --dport 22 -j ACCEPT</code></p> <h2 id="开放-iptables"><a href="#开放-iptables" class="header-anchor">#</a> 开放 iptables</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 首先，我们先把 INPUT、FORWARD、OUTPUT 这三个链的规则设置成 ACCEPT 免得把自己锁在门外：</span>
<span class="token function">sudo</span> iptables -P INPUT ACCEPT
<span class="token function">sudo</span> iptables -P FORWARD ACCEPT
<span class="token function">sudo</span> iptables -P OUTPUT ACCEPT

<span class="token comment"># 然后，我们清除 NAT、Mangle 表，清除链，删除所有的非默认链</span>
<span class="token function">sudo</span> iptables -t nat -F        <span class="token comment">#清除NAT表</span>
<span class="token function">sudo</span> iptables -t mangle -F    <span class="token comment">#清除mangle表</span>
<span class="token function">sudo</span> iptables -F    <span class="token comment">#清除所有链的规则</span>
<span class="token function">sudo</span> iptables -X    <span class="token comment">#删除非默认链</span>
</code></pre></div><p>参考资料：
https://xstarcd.github.io/wiki/Linux/iptables_forward_internetshare.html</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/project-wolves/SPICE-and-Wolf/edit/master/drafts/iptables.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页面</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/SPICE-and-Wolf/assets/js/app.d40a4ed0.js" defer></script><script src="/SPICE-and-Wolf/assets/js/2.a9de799e.js" defer></script><script src="/SPICE-and-Wolf/assets/js/11.15bdea7e.js" defer></script>
  </body>
</html>
